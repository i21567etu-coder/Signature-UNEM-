<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ - Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„ÙˆØ·Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
        }

        .container { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 500px;
            text-align: center;
            margin-top: 50px;
        }

        .site-logo { 
            width: 100px; 
            margin-bottom: 20px; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        h1 { color: #006400; font-size: 24px; margin-bottom: 10px; }
        p { color: #555; margin-bottom: 30px; font-size: 15px; line-height: 1.6; }
        
        .upload-btn {
            background: linear-gradient(135deg, #006400, #004d00);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 100, 0, 0.3);
            width: 100%;
            box-sizing: border-box;
        }
        .upload-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0, 100, 0, 0.4);
        }
        
        #fileInput { display: none; }
        
        .download-btn {
            display: none;
            margin-top: 25px;
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }
        .download-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4);
        }

        .status { margin-top: 20px; font-weight: bold; font-size: 14px; min-height: 20px; }
        .loading { color: #f57c00; }
        .success { color: #006400; }
        .error { color: #d32f2f; }

        footer {
            width: 100%;
            background-color: #1a1a1a;
            padding: 20px 0;
            text-align: center;
            margin-top: auto;
            border-top: 3px solid #006400;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.1);
        }

        .footer-text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            color: #888;
            letter-spacing: 1px;
        }

        .dev-name {
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            margin-right: 5px;
            text-shadow: 0 0 5px #fff, 0 0 10px #00ffcc, 0 0 20px #00ffcc;
            animation: neon-pulse 2s infinite alternate;
        }

        @keyframes neon-pulse {
            0% { text-shadow: 0 0 5px #fff, 0 0 10px #00ffcc; }
            100% { text-shadow: 0 0 2px #fff, 0 0 5px #00ffcc; opacity: 0.9; }
        }
    </style>
</head>
<body>

    <div class="container">
        <img src="logo.png" class="site-logo" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯" onerror="this.style.display='none'">
        <h1>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹</h1>
        <p>ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª PDF ÙˆØ§Ù„ØµÙˆØ± (JPG, PNG).<br>Ø³ÙŠØªÙ… Ø¯Ù…Ø¬ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ø´ÙØ§ÙÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ.</p>

        <label for="fileInput" class="upload-btn">
            <span>ğŸ“‚</span>
            <span>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù (PDF Ø£Ùˆ ØµÙˆØ±Ø©)</span>
        </label>
        <input type="file" id="fileInput" accept="application/pdf, image/png, image/jpeg, image/jpg" onchange="processFile()">

        <div id="status-msg" class="status"></div>

        <a id="download-link" class="download-btn" href="#" download>
            ğŸ“¥ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹
        </a>
    </div>

    <footer>
        <div class="footer-text">
            DÃ©veloppÃ© par <span class="dev-name">Mohamed Dah Agove</span>
        </div>
    </footer>

    <script>
        async function processFile() {
            const fileInput = document.getElementById('fileInput');
            const statusMsg = document.getElementById('status-msg');
            const downloadLink = document.getElementById('download-link');
            const file = fileInput.files[0];

            if (!file) return;

            downloadLink.style.display = 'none';
            statusMsg.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù...";
            statusMsg.className = "status loading";

            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø§Ø±
                const logoResponse = await fetch('logo.png');
                if (!logoResponse.ok) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ logo.png");
                const logoImageBytes = await logoResponse.arrayBuffer();

                const { PDFDocument } = PDFLib;
                let pdfDoc;

                // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù (ØµÙˆØ±Ø© Ø£Ù… PDF)
                if (file.type.startsWith('image/')) {
                    pdfDoc = await PDFDocument.create();
                    const imageBytes = await file.arrayBuffer();
                    let embeddedImage;

                    if (file.type === 'image/png') {
                        embeddedImage = await pdfDoc.embedPng(imageBytes);
                    } else {
                        embeddedImage = await pdfDoc.embedJpg(imageBytes);
                    }

                    const page = pdfDoc.addPage([embeddedImage.width, embeddedImage.height]);
                    
                    page.drawImage(embeddedImage, {
                        x: 0,
                        y: 0,
                        width: embeddedImage.width,
                        height: embeddedImage.height,
                    });

                } else {
                    const pdfBytes = await file.arrayBuffer();
                    pdfDoc = await PDFDocument.load(pdfBytes);
                }

                // 3. ØªØ­Ø¶ÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø±
                let stampImage;
                try {
                    stampImage = await pdfDoc.embedPng(logoImageBytes);
                } catch (e) {
                    stampImage = await pdfDoc.embedJpg(logoImageBytes);
                }

                // 4. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø®ØªØ§Ù…
                const pages = pdfDoc.getPages();
                for (const page of pages) {
                    const { width, height } = page.getSize();
                    
                    // Ø£. Ø§Ù„Ø®ØªÙ… Ø§Ù„Ù…Ø§Ø¦ÙŠ (Ø§Ù„ÙˆØ³Ø· - ÙƒØ¨ÙŠØ± ÙˆÙˆØ§Ø¶Ø­ ÙˆÙ…Ù‚Ø±ÙˆØ¡ Ù…Ø§ ØªØ­ØªÙ‡)
                    const centerScale = 0.5;
                    const centerDims = stampImage.scale(centerScale);
                    page.drawImage(stampImage, {
                        x: (width - centerDims.width) / 2,
                        y: (height - centerDims.height) / 2,
                        width: centerDims.width,
                        height: centerDims.height,
                        opacity: 0.4, // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ¶ÙˆØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
                    });

                    // Ø¨. Ø®ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ (Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø± - Ø´ÙØ§Ù Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Øµ ØªØ­ØªÙ‡)
                    const stampScale = 0.15;
                    const stampDims = stampImage.scale(stampScale);
                    const margin = 20;

                    page.drawImage(stampImage, {
                        x: margin, // ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
                        y: margin, // ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Ø¹Ø§Ø¯Ø© Ø£ÙØ±Øº Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰)
                        width: stampDims.width,
                        height: stampDims.height,
                        opacity: 0.75, // Ø´ÙØ§ÙÙŠØ© ØªØ³Ù…Ø­ Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³ÙˆØ¯ Ù…Ù† ØªØ­Øª Ø§Ù„Ø®ØªÙ…
                    });
                }

                // 5. Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„ØªÙ†Ø²ÙŠÙ„
                const modifiedPdfBytes = await pdfDoc.save();
                const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);

                downloadLink.href = blobUrl;
                const newFileName = file.name.replace(/\.[^/.]+$/, "") + "_signed.pdf";
                downloadLink.download = newFileName;
                
                downloadLink.style.display = 'inline-block';
                statusMsg.innerText = "âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!";
                statusMsg.className = "status success";

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message;
                statusMsg.className = "status error";
            }
        }
    </script>
</body>
</html>