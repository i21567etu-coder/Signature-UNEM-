<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ - Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„ÙˆØ·Ù†ÙŠ</title>
    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø© PDF-Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 20px; 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 600px; 
        }
        /* Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
        .site-logo { width: 100px; margin-bottom: 15px; }
        
        h1 { color: #006400; font-size: 22px; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 25px; font-size: 14px; }
        
        /* Ø²Ø± Ø§Ù„Ø±ÙØ¹ */
        .upload-btn {
            background-color: #006400;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: inline-block;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0, 100, 0, 0.2);
            width: 80%;
        }
        .upload-btn:hover { background-color: #004d00; transform: scale(1.02); }
        
        #pdfInput { display: none; }
        
        /* Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
        #preview-frame { 
            width: 100%; 
            height: 500px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            margin-top: 20px; 
            display: none; 
            background-color: #eee;
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .download-btn {
            display: none;
            margin-top: 20px;
            background-color: #d32f2f;
            color: white;
            padding: 12px 30px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            width: 80%;
        }
        .download-btn:hover { background-color: #b71c1c; }

        .status { margin-top: 15px; font-weight: bold; font-size: 14px; }
        .loading { color: #f57c00; }
        .success { color: #006400; }
        .error { color: #d32f2f; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Ù‡Ø°Ø§ Ø§Ù„Ø´Ø¹Ø§Ø± ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙØ­Ø© -->
        <img src="logo.png" class="site-logo" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØ­Ø§Ø¯" onerror="this.style.display='none'">
        
        <h1>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹</h1>
        <p>Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù PDF Ù„ÙŠØªÙ… ÙˆØ¶Ø¹ Ø®ØªÙ… Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>

        <label for="pdfInput" class="upload-btn">
             ğŸ“„ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF
        </label>
        <input type="file" id="pdfInput" accept="application/pdf" onchange="processPDF()">

        <div id="status-msg" class="status"></div>

        <iframe id="preview-frame"></iframe>
        <a id="download-link" class="download-btn" href="#" download>ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
    </div>

    <script>
        async function processPDF() {
            const fileInput = document.getElementById('pdfInput');
            const statusMsg = document.getElementById('status-msg');
            const file = fileInput.files[0];

            if (!file) return;

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            document.getElementById('preview-frame').style.display = 'none';
            document.getElementById('download-link').style.display = 'none';
            statusMsg.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...";
            statusMsg.className = "status loading";

            try {
                // 1. Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ (Server Fetch)
                const logoUrl = 'logo.png';
                const logoResponse = await fetch(logoUrl);
                
                if (!logoResponse.ok) {
                    throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù logo.png Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù index.html");
                }
                const logoImageBytes = await logoResponse.arrayBuffer();

                // 2. Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF Ø§Ù„Ù…Ø±ÙÙˆØ¹
                const pdfBytes = await file.arrayBuffer();

                // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(pdfBytes);

                // 4. Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø­Ø§ÙˆÙ„Ø© PNG Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… JPG Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹)
                let logoImage;
                try {
                    logoImage = await pdfDoc.embedPng(logoImageBytes);
                } catch (e) {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ€ PNGØŒ Ù†Ø¬Ø±Ø¨ ÙƒÙ€ JPG
                    logoImage = await pdfDoc.embedJpg(logoImageBytes);
                }

                // 5. Ø¶Ø¨Ø· Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø± (0.5 ØªØ¹Ù†ÙŠ Ù†ØµÙ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØµÙˆØ±Ø©)
                const logoDims = logoImage.scale(0.5);

                // 6. ØªÙƒØ±Ø§Ø± Ø§Ù„Ø®ØªÙ… Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
                const pages = pdfDoc.getPages();
                for (const page of pages) {
                    const { width, height } = page.getSize();
                    
                    // ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ø§Ù‹
                    page.drawImage(logoImage, {
                        x: (width - logoDims.width) / 2,
                        y: (height - logoDims.height) / 2,
                        width: logoDims.width,
                        height: logoDims.height,
                        opacity: 0.15, // Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø®ØªÙ… (Watermark)
                    });
                }

                // 7. Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const modifiedPdfBytes = await pdfDoc.save();
                const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                const blobUrl = URL.createObjectURL(blob);

                // 8. Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
                const iframe = document.getElementById('preview-frame');
                iframe.src = blobUrl;
                iframe.style.display = 'block';

                const downloadLink = document.getElementById('download-link');
                downloadLink.href = blobUrl;
                // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© _signed Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                downloadLink.download = file.name.replace('.pdf', '_signed.pdf');
                downloadLink.style.display = 'inline-block';
                downloadLink.innerText = "ğŸ“¥ ØªÙ†Ø²ÙŠÙ„: " + file.name.replace('.pdf', '_signed.pdf');

                statusMsg.innerText = "ØªÙ… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
                statusMsg.className = "status success";

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "Ø®Ø·Ø£: " + err.message;
                statusMsg.className = "status error";
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£! ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù logo.png Ù…Ø±ÙÙˆØ¹ ÙÙŠ GitHub Ø¨Ø¬Ø§Ù†Ø¨ Ù…Ù„Ù index.html");
            }
        }
    </script>
</body>
</html>